import{_ as n,z as s,D as a,X as t}from"./plugin-vue_export-helper.1b30df3c.js";const _='{"title":"\u865A\u62DF\u89C6\u56FE / virtualView","description":"","frontmatter":{},"headers":[{"level":2,"title":"\u6307\u5B9A\u67E5\u8BE2\u6E90","slug":"\u6307\u5B9A\u67E5\u8BE2\u6E90"},{"level":2,"title":"\u7279\u70B9","slug":"\u7279\u70B9"},{"level":3,"title":"\u4E0D\u53EF\u5199","slug":"\u4E0D\u53EF\u5199"},{"level":3,"title":"\u4F9D\u7136\u652F\u6301 ChainFind","slug":"\u4F9D\u7136\u652F\u6301-chainfind"},{"level":2,"title":"\u8DE8\u6570\u636E\u5E93\u5B9A\u4E49 virutalView \u8BED\u53E5","slug":"\u8DE8\u6570\u636E\u5E93\u5B9A\u4E49-virutalview-\u8BED\u53E5"},{"level":3,"title":"\u624B\u52A8\u533A\u5206\u6570\u636E\u5E93\u7C7B\u578B","slug":"\u624B\u52A8\u533A\u5206\u6570\u636E\u5E93\u7C7B\u578B"},{"level":3,"title":"\u4F7F\u7528 knex \u62B9\u5E73\u6570\u636E\u5E93\u5DEE\u5F02","slug":"\u4F7F\u7528-knex-\u62B9\u5E73\u6570\u636E\u5E93\u5DEE\u5F02"},{"level":2,"title":"\u6CE8\u610F\u4E8B\u9879","slug":"\u6CE8\u610F\u4E8B\u9879"}],"relativePath":"orm/virtual-view.md","lastUpdated":1699866965736}',p={},o=t('<h1 id="\u865A\u62DF\u89C6\u56FE-virtualview" tabindex="-1">\u865A\u62DF\u89C6\u56FE / virtualView <a class="header-anchor" href="#\u865A\u62DF\u89C6\u56FE-virtualview" aria-hidden="true">#</a></h1><p>ORM \u4E2D\u7684 model \u53EF\u4EE5\u662F\u865A\u62DF\u89C6\u56FE\uFF0C\u4E5F\u5C31\u662F\u8BF4\uFF0C\u5B83\u4E0D\u662F\u771F\u5B9E\u7684\u6570\u636E\u8868\uFF0C\u800C\u662F\u4E00\u4E2A\u865A\u62DF\u7684\u6570\u636E\u8868\uFF0C\u5B83\u53EF\u4EE5\u901A\u8FC7\u4E00\u4E2A\u7279\u5B9A\u7684\u65B9\u5F0F\u6765\u83B7\u53D6\u771F\u5B9E\u7684\u6570\u636E\u8868.</p><h2 id="\u6307\u5B9A\u67E5\u8BE2\u6E90" tabindex="-1">\u6307\u5B9A\u67E5\u8BE2\u6E90 <a class="header-anchor" href="#\u6307\u5B9A\u67E5\u8BE2\u6E90" aria-hidden="true">#</a></h2><p>\u8003\u8651\u6709\u4EE5\u4E0B\u4E1A\u52A1\u6A21\u578B, \u6211\u4EEC\u6709 <code>class</code> \u548C <code>students_info</code> \u4E24\u4E2A\u8868. \u9996\u5148, \u6211\u4EEC\u5BF9\u8FD9\u4E24\u4E2A\u8868\u5EFA\u6A21:</p><div class="language-js"><pre><code><span class="token keyword">const</span> Class <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">&quot;class&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>\n    <span class="token literal-property property">no</span><span class="token operator">:</span> Number<span class="token punctuation">,</span>\n    <span class="token literal-property property">name</span><span class="token operator">:</span> String\n<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> StudentInfo <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">&quot;students_info&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>\n    <span class="token literal-property property">stu_no</span><span class="token operator">:</span> Number<span class="token punctuation">,</span>\n    <span class="token literal-property property">class_no</span><span class="token operator">:</span> Number<span class="token punctuation">,</span>\n    <span class="token literal-property property">gender</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;male&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;female&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n    <span class="token literal-property property">grade</span><span class="token operator">:</span> Number<span class="token punctuation">,</span>\n    <span class="token literal-property property">height</span><span class="token operator">:</span> Number<span class="token punctuation">,</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n</code></pre></div><p>\u73B0\u5728, \u6211\u4EEC\u60F3\u901A\u8FC7\u4E00\u4E2A\u89C6\u56FE\u6765\u7EDF\u8BA1\u6BCF\u4E2A\u73ED\u7EA7\u7684\u5B66\u751F\u6570\u91CF, \u7537\u751F\u6570\u91CF, \u5E73\u5747\u6210\u7EE9\u548C\u5E73\u5747\u8EAB\u9AD8.</p><p>\u4EE5 mysql \u4E3A\u4F8B, \u6211\u4EEC\u9884\u671F\u901A\u8FC7\u4EE5\u4E0B\u67E5\u8BE2\u8BED\u53E5\u6765\u5F97\u5230\u8FD9\u4E2A\u89C6\u56FE:</p><div class="language-sql"><pre><code><span class="token keyword">select</span> <span class="token identifier"><span class="token punctuation">`</span>class_no<span class="token punctuation">`</span></span> <span class="token keyword">as</span> <span class="token identifier"><span class="token punctuation">`</span>s_class_no<span class="token punctuation">`</span></span><span class="token punctuation">,</span> <span class="token function">count</span><span class="token punctuation">(</span>stu_no<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token identifier"><span class="token punctuation">`</span>students_count<span class="token punctuation">`</span></span><span class="token punctuation">,</span> <span class="token function">count</span><span class="token punctuation">(</span>gender<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token identifier"><span class="token punctuation">`</span>male_count<span class="token punctuation">`</span></span><span class="token punctuation">,</span> <span class="token function">avg</span><span class="token punctuation">(</span>grade<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token identifier"><span class="token punctuation">`</span>avg_grade<span class="token punctuation">`</span></span><span class="token punctuation">,</span> <span class="token function">avg</span><span class="token punctuation">(</span>height<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token identifier"><span class="token punctuation">`</span>avg_height<span class="token punctuation">`</span></span> <span class="token keyword">from</span> <span class="token identifier"><span class="token punctuation">`</span>students_info<span class="token punctuation">`</span></span> <span class="token keyword">group</span> <span class="token keyword">by</span> <span class="token identifier"><span class="token punctuation">`</span>class_no<span class="token punctuation">`</span></span>\n</code></pre></div><p>\u4E3A\u6B64, \u6211\u4EEC\u53EF\u4EE5\u901A\u8FC7 <code>virtualView</code> \u6765\u5B9A\u4E49\u8FD9\u4E2A\u89C6\u56FE:</p><div class="language-js"><pre><code><span class="token keyword">const</span> StudentInfoStatics <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">&quot;class_students_statics&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>\n    <span class="token literal-property property">class_no</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;integer&#39;</span><span class="token punctuation">,</span> <span class="token literal-property property">mapsTo</span><span class="token operator">:</span> <span class="token string">&#39;s_class_no&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token literal-property property">students_count</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;integer&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token literal-property property">male_count</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;integer&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token literal-property property">avg_grade</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;number&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token literal-property property">avg_height</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;number&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>\n    <span class="token literal-property property">virtualView</span><span class="token operator">:</span> <span class="token string">&quot;(select `class_no` as `s_class_no`, count(stu_no) as `students_count`, count(gender) as `male_count`, avg(grade) as `avg_grade`, avg(height) as `avg_height` from `students_info` group by `class_no`)&quot;</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n</code></pre></div><p>\u5F53\u6267\u884C <code>StudentInfoStatics.find().runSync()</code> \u65F6, \u4F1A\u6267\u884C\u4E0A\u8FF0\u7684\u67E5\u8BE2\u8BED\u53E5, \u6700\u7EC8\u6211\u4EEC\u5B9E\u9645\u6267\u884C\u7684\u8BED\u53E5\u5982\u4E0B:</p><div class="language-sql"><pre><code><span class="token keyword">select</span> <span class="token identifier"><span class="token punctuation">`</span>s_class_no<span class="token punctuation">`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>students_count<span class="token punctuation">`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>male_count<span class="token punctuation">`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>avg_grade<span class="token punctuation">`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>avg_height<span class="token punctuation">`</span></span> <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token identifier"><span class="token punctuation">`</span>class_no<span class="token punctuation">`</span></span> <span class="token keyword">as</span> <span class="token identifier"><span class="token punctuation">`</span>s_class_no<span class="token punctuation">`</span></span><span class="token punctuation">,</span> <span class="token function">count</span><span class="token punctuation">(</span>stu_no<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token identifier"><span class="token punctuation">`</span>students_count<span class="token punctuation">`</span></span><span class="token punctuation">,</span> <span class="token function">count</span><span class="token punctuation">(</span>gender<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token identifier"><span class="token punctuation">`</span>male_count<span class="token punctuation">`</span></span><span class="token punctuation">,</span> <span class="token function">avg</span><span class="token punctuation">(</span>grade<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token identifier"><span class="token punctuation">`</span>avg_grade<span class="token punctuation">`</span></span><span class="token punctuation">,</span> <span class="token function">avg</span><span class="token punctuation">(</span>height<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token identifier"><span class="token punctuation">`</span>avg_height<span class="token punctuation">`</span></span> <span class="token keyword">from</span> <span class="token identifier"><span class="token punctuation">`</span>students_info<span class="token punctuation">`</span></span> <span class="token keyword">group</span> <span class="token keyword">by</span> <span class="token identifier"><span class="token punctuation">`</span>class_no<span class="token punctuation">`</span></span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token identifier"><span class="token punctuation">`</span>class_students_statics<span class="token punctuation">`</span></span> <span class="token keyword">limit</span> <span class="token number">1000</span>\n</code></pre></div><p>\u53EF\u4EE5\u770B\u5230, \u6700\u7EC8\u751F\u6210\u7684\u8BED\u53E5\u5E76\u4E0D\u662F\u4ECE\u4E00\u4E2A\u771F\u5B9E\u7684\u6570\u636E\u8868\u4E2D\u67E5\u8BE2, \u800C\u662F\u5C06\u4E00\u4E2A <code>select...as</code> \u4F5C\u4E3A\u67E5\u8BE2\u6E90. \u8FD9\u6837, \u6211\u4EEC\u5C31\u53EF\u4EE5\u901A\u8FC7\u4E00\u4E2A\u865A\u62DF\u89C6\u56FE\u6765\u7EDF\u8BA1\u6570\u636E\u4E86.</p><h2 id="\u7279\u70B9" tabindex="-1">\u7279\u70B9 <a class="header-anchor" href="#\u7279\u70B9" aria-hidden="true">#</a></h2><h3 id="\u4E0D\u53EF\u5199" tabindex="-1">\u4E0D\u53EF\u5199 <a class="header-anchor" href="#\u4E0D\u53EF\u5199" aria-hidden="true">#</a></h3><p>\u5F53\u4E00\u4E2A orm model \u88AB\u6307\u5B9A\u4E86 <code>virtualView</code> \u540E, \u5B83\u50CF\u53D8\u6210\u4E00\u4E2A\u7EAF\u7CB9\u7684 virtualView model, \u5176\u4E2D\u5B9A\u4E49\u7684\u6240\u6709 property \u90FD\u662F<strong>\u53EA\u53EF\u8BFB\u800C\u4E0D\u53EF\u4EE5\u5199</strong>\u7684, \u5E76\u4E00\u4E00\u6620\u5C04\u5230\u67E5\u8BE2\u6E90.</p><p>virtualView model \u5C31\u4E0D\u518D\u6620\u5C04\u5230\u4E00\u4E2A\u771F\u5B9E\u7684\u6570\u636E\u8868, \u56E0\u6B64, \u5B83<strong>\u4E0D</strong>\u652F\u6301\u5199\u5165\u7C7B\u64CD\u4F5C\u5982 <code>create</code>, <code>update</code>, <code>remove</code> \u7B49.</p><h3 id="\u4F9D\u7136\u652F\u6301-chainfind" tabindex="-1">\u4F9D\u7136\u652F\u6301 ChainFind <a class="header-anchor" href="#\u4F9D\u7136\u652F\u6301-chainfind" aria-hidden="true">#</a></h3><p><code>model.find()</code> \u4F1A\u8FD4\u56DE\u4E00\u4E2A <code>ChainFind</code> \u5BF9\u8C61, \u901A\u8FC7\u8FD9\u4E2A\u5BF9\u8C61, \u6211\u4EEC\u53EF\u4EE5\u5BF9\u67E5\u8BE2\u7ED3\u679C\u8FDB\u884C\u8FDB\u4E00\u6B65\u7684\u8FC7\u6EE4, \u6392\u5E8F, \u5206\u9875\u7B49\u64CD\u4F5C. \u8FD9\u4E00\u7279\u6027\u4F9D\u7136\u9002\u7528\u4E8E virtualView model.</p><p>\u4EE5\u4E0A\u6587\u7684 <code>StudentInfoStatics</code> \u4E3A\u4F8B, \u6211\u4EEC\u53EF\u4EE5\u6309\u7167\u5B66\u751F\u5E73\u5747\u6210\u7EE9\u5BF9\u7EDF\u8BA1\u4FE1\u606F\u8FDB\u884C\u964D\u5E8F\u6392\u5E8F:</p><div class="language-js"><pre><code>StudentInfoStatics<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">order</span><span class="token punctuation">(</span><span class="token string">&#39;-avg_grade&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">runSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n<span class="token comment">// select `s_class_no`, `students_count`, `male_count`, `avg_grade`, `avg_height` from (select `class_no` as `s_class_no`, count(stu_no) as `students_count`, count(gender) as `male_count`, avg(grade) as `avg_grade`, avg(height) as `avg_height` from `students_info` group by `class_no`) as `class_students_statics` order by `avg_grade` DESC limit 1000</span>\n</code></pre></div><p>\u6211\u4EEC\u4E5F\u53EF\u4EE5\u901A\u8FC7 <code>limit</code> \u548C <code>offset</code> \u6765\u5206\u9875:</p><div class="language-js"><pre><code>StudentInfoStatics<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">runSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n<span class="token comment">// select `s_class_no`, `students_count`, `male_count`, `avg_grade`, `avg_height` from (select `class_no` as `s_class_no`, count(stu_no) as `students_count`, count(gender) as `male_count`, avg(grade) as `avg_grade`, avg(height) as `avg_height` from `students_info` group by `class_no`) as `class_students_statics` limit 10 offset 10</span>\n</code></pre></div><p>\u4E5F\u53EF\u4EE5\u901A\u8FC7 <code>where</code> \u6765\u8FC7\u6EE4:</p><div class="language-js"><pre><code>StudentInfoStatics<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">class_no</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">runSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n<span class="token comment">// select `s_class_no`, `students_count`, `male_count`, `avg_grade`, `avg_height` from (select `class_no` as `s_class_no`, count(stu_no) as `students_count`, count(gender) as `male_count`, avg(grade) as `avg_grade`, avg(height) as `avg_height` from `students_info` group by `class_no`) as `class_students_statics` where `s_class_no` = 1 limit 1000</span>\n</code></pre></div><h2 id="\u8DE8\u6570\u636E\u5E93\u5B9A\u4E49-virutalview-\u8BED\u53E5" tabindex="-1">\u8DE8\u6570\u636E\u5E93\u5B9A\u4E49 virutalView \u8BED\u53E5 <a class="header-anchor" href="#\u8DE8\u6570\u636E\u5E93\u5B9A\u4E49-virutalview-\u8BED\u53E5" aria-hidden="true">#</a></h2><h3 id="\u624B\u52A8\u533A\u5206\u6570\u636E\u5E93\u7C7B\u578B" tabindex="-1">\u624B\u52A8\u533A\u5206\u6570\u636E\u5E93\u7C7B\u578B <a class="header-anchor" href="#\u624B\u52A8\u533A\u5206\u6570\u636E\u5E93\u7C7B\u578B" aria-hidden="true">#</a></h3><p>\u4F60\u7684 orm \u5B9A\u4E49\u53EF\u80FD\u662F\u8FD0\u884C\u5728\u4E0D\u540C\u6570\u636E\u5E93 backend \u4E0A\u7684, \u5728\u5B9A\u4E49 virtualView \u65F6, \u4F60\u53EF\u4EE5\u901A\u8FC7 <code>db.driver.sqlDriver.type</code> \u6765\u5224\u65AD\u5F53\u524D\u8FD0\u884C\u7684\u6570\u636E\u5E93\u7C7B\u578B, \u7136\u540E\u6839\u636E\u4E0D\u540C\u7684\u6570\u636E\u5E93\u7C7B\u578B\u6765\u5B9A\u4E49\u4E0D\u540C\u7684 virtualView \u8BED\u53E5. \u5982:</p><div class="language-js"><pre><code><span class="token keyword">const</span> StudentInfoStatics <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">&quot;class_students_statics&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>\n    <span class="token literal-property property">class_no</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;integer&#39;</span><span class="token punctuation">,</span> <span class="token literal-property property">mapsTo</span><span class="token operator">:</span> <span class="token string">&#39;s_class_no&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token literal-property property">students_count</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;integer&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token literal-property property">male_count</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;integer&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token literal-property property">avg_grade</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;number&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token literal-property property">avg_height</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;number&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>\n    <span class="token literal-property property">virtualView</span><span class="token operator">:</span> db<span class="token punctuation">.</span>driver<span class="token punctuation">.</span>sqlDriver<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&#39;sqlite&#39;</span> <span class="token operator">?</span> <span class="token string">&quot;(select `class_no` as `s_class_no`, count(stu_no) as `students_count`, count(gender) as `male_count`, avg(grade) as `avg_grade`, avg(height) as `avg_height` from `students_info` group by `class_no`)&quot;</span>\n    <span class="token operator">:</span> db<span class="token punctuation">.</span>driver<span class="token punctuation">.</span>sqlDriver<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&#39;mysql&#39;</span> <span class="token operator">?</span> <span class="token string">&quot;(select `class_no` as `s_class_no`, count(stu_no) as `students_count`, count(gender) as `male_count`, avg(grade) as `avg_grade`, avg(height) as `avg_height` from `students_info` group by `class_no`)&quot;</span>\n    <span class="token operator">:</span> db<span class="token punctuation">.</span>driver<span class="token punctuation">.</span>sqlDriver<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&#39;psql&#39;</span> <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">(select &quot;class_no&quot; as &quot;s_class_no&quot;, count(stu_no) as &quot;students_count&quot;, count(gender) as &quot;male_count&quot;, avg(grade) as &quot;avg_grade&quot;, avg(height) as &quot;avg_height&quot; from &quot;students_info&quot; group by &quot;class_no&quot;)</span><span class="token template-punctuation string">`</span></span>\n    <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n</code></pre></div><h3 id="\u4F7F\u7528-knex-\u62B9\u5E73\u6570\u636E\u5E93\u5DEE\u5F02" tabindex="-1">\u4F7F\u7528 knex \u62B9\u5E73\u6570\u636E\u5E93\u5DEE\u5F02 <a class="header-anchor" href="#\u4F7F\u7528-knex-\u62B9\u5E73\u6570\u636E\u5E93\u5DEE\u5F02" aria-hidden="true">#</a></h3><p>\u4F60\u4E5F\u53EF\u4EE5\u4F7F\u7528 <a href="./../orm-packages/knex.html">db.driver.knex</a> \u6765\u62B9\u5E73\u4E0D\u540C\u6570\u636E\u5E93\u7684\u5DEE\u5F02, \u5982:</p><div class="language-js"><pre><code><span class="token keyword">const</span> knex <span class="token operator">=</span> db<span class="token punctuation">.</span>driver<span class="token punctuation">.</span>knex<span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> StudentInfoStatics <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">&quot;class_students_statics&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>\n    <span class="token literal-property property">class_no</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;integer&#39;</span><span class="token punctuation">,</span> <span class="token literal-property property">mapsTo</span><span class="token operator">:</span> <span class="token string">&#39;s_class_no&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token literal-property property">students_count</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;integer&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token literal-property property">male_count</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;integer&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token literal-property property">avg_grade</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;number&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token literal-property property">avg_height</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;number&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>\n    <span class="token literal-property property">virtualView</span><span class="token operator">:</span> knex<span class="token punctuation">.</span><span class="token function">table</span><span class="token punctuation">(</span><span class="token string">&#39;students_info&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span>\n        <span class="token string">&#39;class_no as s_class_no&#39;</span><span class="token punctuation">,</span>\n        knex<span class="token punctuation">.</span><span class="token function">raw</span><span class="token punctuation">(</span><span class="token string">&#39;count(stu_no) as ??&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">&#39;students_count&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n        knex<span class="token punctuation">.</span><span class="token function">raw</span><span class="token punctuation">(</span><span class="token string">&#39;count(gender) as ??&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">&#39;male_count&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n        knex<span class="token punctuation">.</span><span class="token function">raw</span><span class="token punctuation">(</span><span class="token string">&#39;avg(grade) as ??&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">&#39;avg_grade&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n        knex<span class="token punctuation">.</span><span class="token function">raw</span><span class="token punctuation">(</span><span class="token string">&#39;avg(height) as ??&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">&#39;avg_height&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">groupBy</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&#39;class_no&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n</code></pre></div><p><strong>\u6CE8\u610F</strong> \u6B64\u65F6\u4F20\u9012\u7ED9 virtualView \u7684\u53C2\u6570\u5FC5\u987B\u662F\u4E00\u4E2A knex \u5BF9\u8C61, \u800C\u4E0D\u662F\u4E00\u4E2A\u5B57\u7B26\u4E32.</p><p>\u5173\u4E8E knex \u7684\u66F4\u591A\u7528\u6CD5, \u8BF7\u53C2\u8003 <a href="https://knexjs.org/" target="_blank" rel="noopener noreferrer">knex \u6587\u6863</a>.</p><h2 id="\u6CE8\u610F\u4E8B\u9879" tabindex="-1">\u6CE8\u610F\u4E8B\u9879 <a class="header-anchor" href="#\u6CE8\u610F\u4E8B\u9879" aria-hidden="true">#</a></h2><ul><li>virtualView \u4E2D\u7684\u8BED\u53E5\u4F1A\u88AB\u76F4\u63A5\u5F53\u505A\u67E5\u8BE2\u6E90, \u56E0\u6B64, \u8BF7\u786E\u4FDD virtualView \u4E2D\u7684\u8BED\u53E5\u662F\u6B63\u786E\u7684.</li><li>\u4F20\u7ED9 virtualView \u7684\u53C2\u6570\u5982\u679C\u662F\u5B57\u7B26\u4E32, \u5219\u5FC5\u987B\u88AB\u5F15\u53F7\u5305\u88F9, \u4F8B\u5982:</li></ul><div class="language-js"><pre><code><span class="token comment">// correct</span>\n<span class="token punctuation">{</span>\n    <span class="token literal-property property">virtualView</span><span class="token operator">:</span> <span class="token string">&quot;(select * from `students_info` where `class_no` = &#39;1&#39;)&quot;</span> \n<span class="token punctuation">}</span>\n\n<span class="token comment">// incorrect</span>\n<span class="token punctuation">{</span>\n    <span class="token literal-property property">virtualView</span><span class="token operator">:</span> <span class="token string">&quot;select * from `students_info` where `class_no` = &#39;1&#39;&quot;</span>\n<span class="token punctuation">}</span>\n</code></pre></div>',37),e=[o];function c(l,u,r,i,k,d){return a(),s("div",null,e)}var y=n(p,[["render",c]]);export{_ as __pageData,y as default};

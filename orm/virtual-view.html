<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>虚拟视图 / virtualView | FxJS ORM</title>
    <meta name="description" content="最好用的 FibJS ORM 框架">
    <link rel="stylesheet" href="/orm/assets/style.2853df4f.css">
    <link rel="modulepreload" href="/orm/assets/plugin-vue_export-helper.1f71b9e3.js">
    <link rel="modulepreload" href="/orm/assets/Home.60deff64.js">
    <link rel="modulepreload" href="/orm/assets/orm_virtual-view.md.125b61b8.lean.js">
    <link rel="modulepreload" href="/orm/assets/app.24e8e552.js">
    
    <meta name="twitter:title" content="虚拟视图 / virtualView | FxJS ORM">
  <meta property="og:title" content="虚拟视图 / virtualView | FxJS ORM">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme"><header class="nav-bar" data-v-40587210><div class="sidebar-button" data-v-40587210><svg class="icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z" class></path></svg></div><a class="nav-bar-title" href="/orm/" aria-label="FxJS ORM, back to home" data-v-40587210 data-v-016a8bd8><!----> FxJS ORM</a><div class="flex-grow" data-v-40587210></div><div class="nav" data-v-40587210><nav class="nav-links" data-v-40587210 data-v-35b91e7e><!--[--><div class="item" data-v-35b91e7e><div class="nav-link" data-v-35b91e7e data-v-49fe041d><a class="item active" href="/orm/orm/getting-started" data-v-49fe041d>ORM <!----></a></div></div><div class="item" data-v-35b91e7e><div class="nav-link" data-v-35b91e7e data-v-49fe041d><a class="item" href="/orm/clis/orm" data-v-49fe041d>CLI <!----></a></div></div><!--]--><!----><div class="item" data-v-35b91e7e><div class="nav-link" data-v-35b91e7e data-v-49fe041d><a class="item isExternal" href="https://github.com/fxjs-modules/orm" target="_blank" rel="noopener noreferrer" data-v-49fe041d>GitHub <svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" data-v-49fe041d><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div></div></nav></div><!--[--><!--]--></header><aside class="sidebar" data-v-17c48e2f><nav class="nav-links nav" data-v-17c48e2f data-v-35b91e7e><!--[--><div class="item" data-v-35b91e7e><div class="nav-link" data-v-35b91e7e data-v-49fe041d><a class="item active" href="/orm/orm/getting-started" data-v-49fe041d>ORM <!----></a></div></div><div class="item" data-v-35b91e7e><div class="nav-link" data-v-35b91e7e data-v-49fe041d><a class="item" href="/orm/clis/orm" data-v-49fe041d>CLI <!----></a></div></div><!--]--><!----><div class="item" data-v-35b91e7e><div class="nav-link" data-v-35b91e7e data-v-49fe041d><a class="item isExternal" href="https://github.com/fxjs-modules/orm" target="_blank" rel="noopener noreferrer" data-v-49fe041d>GitHub <svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" data-v-49fe041d><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div></div></nav><!--[--><!--]--><ul class="sidebar-links" data-v-17c48e2f><!--[--><li class="sidebar-link"><a class="sidebar-link-item" href="/orm/orm/getting-started">开始连接</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="/orm/orm/property">Property</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item active" href="/orm/orm/virtual-view">虚拟视图</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="#指定查询源">指定查询源</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#特点">特点</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="#不可写">不可写</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#依然支持-chainfind">依然支持 ChainFind</a><!----></li></ul></li><li class="sidebar-link"><a class="sidebar-link-item" href="#跨数据库定义-virutalview-语句">跨数据库定义 virutalView 语句</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="#手动区分数据库类型">手动区分数据库类型</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#使用-knex-抹平数据库差异">使用 knex 抹平数据库差异</a><!----></li></ul></li><li class="sidebar-link"><a class="sidebar-link-item" href="#注意事项">注意事项</a><!----></li></ul></li><li class="sidebar-link"><a class="sidebar-link-item" href="/orm/orm/plugins">ORM 插件</a><!----></li></ul></li><li class="sidebar-link"><a class="sidebar-link-item" href="/orm/orm-packages/">Packages</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="/orm/orm-packages/orm-core">orm-core</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/orm/orm-packages/orm-property">orm-property</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/orm/orm-packages/db-driver">db-driver</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/orm/orm-packages/knex">knex</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/orm/orm-packages/sql-query">sql-query</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/orm/orm-packages/sql-ddl-sync">sql-ddl-sync</a><!----></li></ul></li><!--]--></ul><!--[--><!--]--></aside><div class="sidebar-mask"></div><main class="page" data-v-8fcebc32><div class="container" data-v-8fcebc32><!--[--><!--]--><div style="position:relative;" class="content" data-v-8fcebc32><div><h1 id="虚拟视图-virtualview" tabindex="-1">虚拟视图 / virtualView <a class="header-anchor" href="#虚拟视图-virtualview" aria-hidden="true">#</a></h1><p>ORM 中的 model 可以是虚拟视图，也就是说，它不是真实的数据表，而是一个虚拟的数据表，它可以通过一个特定的方式来获取真实的数据表.</p><h2 id="指定查询源" tabindex="-1">指定查询源 <a class="header-anchor" href="#指定查询源" aria-hidden="true">#</a></h2><p>考虑有以下业务模型, 我们有 <code>class</code> 和 <code>students_info</code> 两个表. 首先, 我们对这两个表建模:</p><div class="language-js"><pre><code><span class="token keyword">const</span> Class <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">&quot;class&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">no</span><span class="token operator">:</span> Number<span class="token punctuation">,</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> String
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> StudentInfo <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">&quot;students_info&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">stu_no</span><span class="token operator">:</span> Number<span class="token punctuation">,</span>
    <span class="token literal-property property">class_no</span><span class="token operator">:</span> Number<span class="token punctuation">,</span>
    <span class="token literal-property property">gender</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;male&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;female&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token literal-property property">grade</span><span class="token operator">:</span> Number<span class="token punctuation">,</span>
    <span class="token literal-property property">height</span><span class="token operator">:</span> Number<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>现在, 我们想通过一个视图来统计每个班级的学生数量, 男生数量, 平均成绩和平均身高.</p><p>以 mysql 为例, 我们预期通过以下查询语句来得到这个视图:</p><div class="language-sql"><pre><code><span class="token keyword">select</span> <span class="token identifier"><span class="token punctuation">`</span>class_no<span class="token punctuation">`</span></span> <span class="token keyword">as</span> <span class="token identifier"><span class="token punctuation">`</span>s_class_no<span class="token punctuation">`</span></span><span class="token punctuation">,</span> <span class="token function">count</span><span class="token punctuation">(</span>stu_no<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token identifier"><span class="token punctuation">`</span>students_count<span class="token punctuation">`</span></span><span class="token punctuation">,</span> <span class="token function">count</span><span class="token punctuation">(</span>gender<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token identifier"><span class="token punctuation">`</span>male_count<span class="token punctuation">`</span></span><span class="token punctuation">,</span> <span class="token function">avg</span><span class="token punctuation">(</span>grade<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token identifier"><span class="token punctuation">`</span>avg_grade<span class="token punctuation">`</span></span><span class="token punctuation">,</span> <span class="token function">avg</span><span class="token punctuation">(</span>height<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token identifier"><span class="token punctuation">`</span>avg_height<span class="token punctuation">`</span></span> <span class="token keyword">from</span> <span class="token identifier"><span class="token punctuation">`</span>students_info<span class="token punctuation">`</span></span> <span class="token keyword">group</span> <span class="token keyword">by</span> <span class="token identifier"><span class="token punctuation">`</span>class_no<span class="token punctuation">`</span></span>
</code></pre></div><p>为此, 我们可以通过 <code>virtualView</code> 来定义这个视图:</p><div class="language-js"><pre><code><span class="token keyword">const</span> StudentInfoStatics <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">&quot;class_students_statics&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">class_no</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;integer&#39;</span><span class="token punctuation">,</span> <span class="token literal-property property">mapsTo</span><span class="token operator">:</span> <span class="token string">&#39;s_class_no&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">students_count</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;integer&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">male_count</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;integer&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">avg_grade</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;number&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">avg_height</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;number&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">virtualView</span><span class="token operator">:</span> <span class="token string">&quot;(select `class_no` as `s_class_no`, count(stu_no) as `students_count`, count(gender) as `male_count`, avg(grade) as `avg_grade`, avg(height) as `avg_height` from `students_info` group by `class_no`)&quot;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>当执行 <code>StudentInfoStatics.find().runSync()</code> 时, 会执行上述的查询语句, 最终我们实际执行的语句如下:</p><div class="language-sql"><pre><code><span class="token keyword">select</span> <span class="token identifier"><span class="token punctuation">`</span>s_class_no<span class="token punctuation">`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>students_count<span class="token punctuation">`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>male_count<span class="token punctuation">`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>avg_grade<span class="token punctuation">`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>avg_height<span class="token punctuation">`</span></span> <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token identifier"><span class="token punctuation">`</span>class_no<span class="token punctuation">`</span></span> <span class="token keyword">as</span> <span class="token identifier"><span class="token punctuation">`</span>s_class_no<span class="token punctuation">`</span></span><span class="token punctuation">,</span> <span class="token function">count</span><span class="token punctuation">(</span>stu_no<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token identifier"><span class="token punctuation">`</span>students_count<span class="token punctuation">`</span></span><span class="token punctuation">,</span> <span class="token function">count</span><span class="token punctuation">(</span>gender<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token identifier"><span class="token punctuation">`</span>male_count<span class="token punctuation">`</span></span><span class="token punctuation">,</span> <span class="token function">avg</span><span class="token punctuation">(</span>grade<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token identifier"><span class="token punctuation">`</span>avg_grade<span class="token punctuation">`</span></span><span class="token punctuation">,</span> <span class="token function">avg</span><span class="token punctuation">(</span>height<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token identifier"><span class="token punctuation">`</span>avg_height<span class="token punctuation">`</span></span> <span class="token keyword">from</span> <span class="token identifier"><span class="token punctuation">`</span>students_info<span class="token punctuation">`</span></span> <span class="token keyword">group</span> <span class="token keyword">by</span> <span class="token identifier"><span class="token punctuation">`</span>class_no<span class="token punctuation">`</span></span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token identifier"><span class="token punctuation">`</span>class_students_statics<span class="token punctuation">`</span></span> <span class="token keyword">limit</span> <span class="token number">1000</span>
</code></pre></div><p>可以看到, 最终生成的语句并不是从一个真实的数据表中查询, 而是将一个 <code>select...as</code> 作为查询源. 这样, 我们就可以通过一个虚拟视图来统计数据了.</p><h2 id="特点" tabindex="-1">特点 <a class="header-anchor" href="#特点" aria-hidden="true">#</a></h2><h3 id="不可写" tabindex="-1">不可写 <a class="header-anchor" href="#不可写" aria-hidden="true">#</a></h3><p>当一个 orm model 被指定了 <code>virtualView</code> 后, 它像变成一个纯粹的 virtualView model, 其中定义的所有 property 都是<strong>只可读而不可以写</strong>的, 并一一映射到查询源.</p><p>virtualView model 就不再映射到一个真实的数据表, 因此, 它<strong>不</strong>支持写入类操作如 <code>create</code>, <code>update</code>, <code>remove</code> 等.</p><h3 id="依然支持-chainfind" tabindex="-1">依然支持 ChainFind <a class="header-anchor" href="#依然支持-chainfind" aria-hidden="true">#</a></h3><p><code>model.find()</code> 会返回一个 <code>ChainFind</code> 对象, 通过这个对象, 我们可以对查询结果进行进一步的过滤, 排序, 分页等操作. 这一特性依然适用于 virtualView model.</p><p>以上文的 <code>StudentInfoStatics</code> 为例, 我们可以按照学生平均成绩对统计信息进行降序排序:</p><div class="language-js"><pre><code>StudentInfoStatics<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">order</span><span class="token punctuation">(</span><span class="token string">&#39;-avg_grade&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">runSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// select `s_class_no`, `students_count`, `male_count`, `avg_grade`, `avg_height` from (select `class_no` as `s_class_no`, count(stu_no) as `students_count`, count(gender) as `male_count`, avg(grade) as `avg_grade`, avg(height) as `avg_height` from `students_info` group by `class_no`) as `class_students_statics` order by `avg_grade` DESC limit 1000</span>
</code></pre></div><p>我们也可以通过 <code>limit</code> 和 <code>offset</code> 来分页:</p><div class="language-js"><pre><code>StudentInfoStatics<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">runSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// select `s_class_no`, `students_count`, `male_count`, `avg_grade`, `avg_height` from (select `class_no` as `s_class_no`, count(stu_no) as `students_count`, count(gender) as `male_count`, avg(grade) as `avg_grade`, avg(height) as `avg_height` from `students_info` group by `class_no`) as `class_students_statics` limit 10 offset 10</span>
</code></pre></div><p>也可以通过 <code>where</code> 来过滤:</p><div class="language-js"><pre><code>StudentInfoStatics<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">class_no</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">runSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// select `s_class_no`, `students_count`, `male_count`, `avg_grade`, `avg_height` from (select `class_no` as `s_class_no`, count(stu_no) as `students_count`, count(gender) as `male_count`, avg(grade) as `avg_grade`, avg(height) as `avg_height` from `students_info` group by `class_no`) as `class_students_statics` where `s_class_no` = 1 limit 1000</span>
</code></pre></div><h2 id="跨数据库定义-virutalview-语句" tabindex="-1">跨数据库定义 virutalView 语句 <a class="header-anchor" href="#跨数据库定义-virutalview-语句" aria-hidden="true">#</a></h2><h3 id="手动区分数据库类型" tabindex="-1">手动区分数据库类型 <a class="header-anchor" href="#手动区分数据库类型" aria-hidden="true">#</a></h3><p>你的 orm 定义可能是运行在不同数据库 backend 上的, 在定义 virtualView 时, 你可以通过 <code>db.driver.sqlDriver.type</code> 来判断当前运行的数据库类型, 然后根据不同的数据库类型来定义不同的 virtualView 语句. 如:</p><div class="language-js"><pre><code><span class="token keyword">const</span> StudentInfoStatics <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">&quot;class_students_statics&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">class_no</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;integer&#39;</span><span class="token punctuation">,</span> <span class="token literal-property property">mapsTo</span><span class="token operator">:</span> <span class="token string">&#39;s_class_no&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">students_count</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;integer&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">male_count</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;integer&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">avg_grade</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;number&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">avg_height</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;number&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">virtualView</span><span class="token operator">:</span> db<span class="token punctuation">.</span>driver<span class="token punctuation">.</span>sqlDriver<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&#39;sqlite&#39;</span> <span class="token operator">?</span> <span class="token string">&quot;(select `class_no` as `s_class_no`, count(stu_no) as `students_count`, count(gender) as `male_count`, avg(grade) as `avg_grade`, avg(height) as `avg_height` from `students_info` group by `class_no`)&quot;</span>
    <span class="token operator">:</span> db<span class="token punctuation">.</span>driver<span class="token punctuation">.</span>sqlDriver<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&#39;mysql&#39;</span> <span class="token operator">?</span> <span class="token string">&quot;(select `class_no` as `s_class_no`, count(stu_no) as `students_count`, count(gender) as `male_count`, avg(grade) as `avg_grade`, avg(height) as `avg_height` from `students_info` group by `class_no`)&quot;</span>
    <span class="token operator">:</span> db<span class="token punctuation">.</span>driver<span class="token punctuation">.</span>sqlDriver<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&#39;psql&#39;</span> <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">(select &quot;class_no&quot; as &quot;s_class_no&quot;, count(stu_no) as &quot;students_count&quot;, count(gender) as &quot;male_count&quot;, avg(grade) as &quot;avg_grade&quot;, avg(height) as &quot;avg_height&quot; from &quot;students_info&quot; group by &quot;class_no&quot;)</span><span class="token template-punctuation string">`</span></span>
    <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="使用-knex-抹平数据库差异" tabindex="-1">使用 knex 抹平数据库差异 <a class="header-anchor" href="#使用-knex-抹平数据库差异" aria-hidden="true">#</a></h3><p>你也可以使用 <a href="./../orm-packages/knex.html">db.driver.knex</a> 来抹平不同数据库的差异, 如:</p><div class="language-js"><pre><code><span class="token keyword">const</span> knex <span class="token operator">=</span> db<span class="token punctuation">.</span>driver<span class="token punctuation">.</span>knex<span class="token punctuation">;</span>

<span class="token keyword">const</span> StudentInfoStatics <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">&quot;class_students_statics&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">class_no</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;integer&#39;</span><span class="token punctuation">,</span> <span class="token literal-property property">mapsTo</span><span class="token operator">:</span> <span class="token string">&#39;s_class_no&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">students_count</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;integer&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">male_count</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;integer&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">avg_grade</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;number&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">avg_height</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;number&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">virtualView</span><span class="token operator">:</span> knex<span class="token punctuation">.</span><span class="token function">table</span><span class="token punctuation">(</span><span class="token string">&#39;students_info&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span>
        <span class="token string">&#39;class_no as s_class_no&#39;</span><span class="token punctuation">,</span>
        knex<span class="token punctuation">.</span><span class="token function">raw</span><span class="token punctuation">(</span><span class="token string">&#39;count(stu_no) as ??&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">&#39;students_count&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        knex<span class="token punctuation">.</span><span class="token function">raw</span><span class="token punctuation">(</span><span class="token string">&#39;count(gender) as ??&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">&#39;male_count&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        knex<span class="token punctuation">.</span><span class="token function">raw</span><span class="token punctuation">(</span><span class="token string">&#39;avg(grade) as ??&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">&#39;avg_grade&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        knex<span class="token punctuation">.</span><span class="token function">raw</span><span class="token punctuation">(</span><span class="token string">&#39;avg(height) as ??&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">&#39;avg_height&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">groupBy</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&#39;class_no&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><strong>注意</strong> 此时传递给 virtualView 的参数必须是一个 knex 对象, 而不是一个字符串.</p><p>关于 knex 的更多用法, 请参考 <a href="https://knexjs.org/" target="_blank" rel="noopener noreferrer">knex 文档</a>.</p><h2 id="注意事项" tabindex="-1">注意事项 <a class="header-anchor" href="#注意事项" aria-hidden="true">#</a></h2><ul><li>virtualView 中的语句会被直接当做查询源, 因此, 请确保 virtualView 中的语句是正确的.</li><li>传给 virtualView 的参数如果是字符串, 则必须被引号包裹, 例如:</li></ul><div class="language-js"><pre><code><span class="token comment">// correct</span>
<span class="token punctuation">{</span>
    <span class="token literal-property property">virtualView</span><span class="token operator">:</span> <span class="token string">&quot;(select * from `students_info` where `class_no` = &#39;1&#39;)&quot;</span> 
<span class="token punctuation">}</span>

<span class="token comment">// incorrect</span>
<span class="token punctuation">{</span>
    <span class="token literal-property property">virtualView</span><span class="token operator">:</span> <span class="token string">&quot;select * from `students_info` where `class_no` = &#39;1&#39;&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div></div></div><footer class="page-footer" data-v-8fcebc32 data-v-5c96fb00><div class="edit" data-v-5c96fb00><div class="edit-link" data-v-5c96fb00 data-v-55695e90><a class="link" href="https://github.com/fxjs-modules/orm/edit/master/docs/orm/virtual-view.md" target="_blank" rel="noopener noreferrer" data-v-55695e90>在 Github 上编辑此页 <svg class="icon outbound icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" data-v-55695e90><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div></div><div class="updated" data-v-5c96fb00><p class="last-updated" data-v-5c96fb00 data-v-30c3cbb4><span class="prefix" data-v-30c3cbb4>最近更新:</span><span class="datetime" data-v-30c3cbb4></span></p></div></footer><div class="next-and-prev-link" data-v-8fcebc32 data-v-e65a9748><div class="container" data-v-e65a9748><div class="prev" data-v-e65a9748><a class="link" href="/orm/orm/property" data-v-e65a9748><svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" class="icon icon-prev" data-v-e65a9748><path d="M19,11H7.4l5.3-5.3c0.4-0.4,0.4-1,0-1.4s-1-0.4-1.4,0l-7,7c-0.1,0.1-0.2,0.2-0.2,0.3c-0.1,0.2-0.1,0.5,0,0.8c0.1,0.1,0.1,0.2,0.2,0.3l7,7c0.2,0.2,0.5,0.3,0.7,0.3s0.5-0.1,0.7-0.3c0.4-0.4,0.4-1,0-1.4L7.4,13H19c0.6,0,1-0.4,1-1S19.6,11,19,11z"></path></svg><span class="text" data-v-e65a9748>Property</span></a></div><div class="next" data-v-e65a9748><a class="link" href="/orm/orm/plugins" data-v-e65a9748><span class="text" data-v-e65a9748>ORM 插件</span><svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" class="icon icon-next" data-v-e65a9748><path d="M19.9,12.4c0.1-0.2,0.1-0.5,0-0.8c-0.1-0.1-0.1-0.2-0.2-0.3l-7-7c-0.4-0.4-1-0.4-1.4,0s-0.4,1,0,1.4l5.3,5.3H5c-0.6,0-1,0.4-1,1s0.4,1,1,1h11.6l-5.3,5.3c-0.4,0.4-0.4,1,0,1.4c0.2,0.2,0.5,0.3,0.7,0.3s0.5-0.1,0.7-0.3l7-7C19.8,12.6,19.9,12.5,19.9,12.4z"></path></svg></a></div></div></div><!--[--><!--]--></div></main></div><!----><!--]--></div>
    <script>__VP_HASH_MAP__ = JSON.parse("{\"clis_orm.md\":\"fdc5eedc\",\"index.md\":\"f3808b77\",\"orm-packages_db-driver.md\":\"cbfe0e97\",\"orm-packages_index.md\":\"2bc60084\",\"orm-packages_knex.md\":\"3ce092bb\",\"orm-packages_orm-core.md\":\"f18f116a\",\"orm-packages_orm-property.md\":\"df564c40\",\"orm-packages_sql-ddl-sync.md\":\"2b978086\",\"orm-packages_sql-query.md\":\"053ca417\",\"orm_adapters.md\":\"ea7cbeca\",\"orm_connect-db.md\":\"94f3bf45\",\"orm_getting-started.md\":\"80406e93\",\"orm_index.md\":\"145ab6d8\",\"orm_plugins.md\":\"00f13e86\",\"orm_property.md\":\"cacb21e7\",\"orm_virtual-view.md\":\"125b61b8\",\"rfcs_0000-style.md\":\"773d07c2\"}")</script>
    <script type="module" async src="/orm/assets/app.24e8e552.js"></script>
    
  </body>
</html>